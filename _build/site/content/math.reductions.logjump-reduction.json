{"version":2,"kind":"Notebook","sha256":"5baba7773074d0c75840fa4a87876a518bbfb87b85c122899c064de8f3eb1a6b","slug":"math.reductions.logjump-reduction","location":"/math/reductions/logjump_reduction.ipynb","dependencies":[],"frontmatter":{"title":"Classic Montgomery REDC","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"github":"https://github.com/executablebooks/jupyter-book","numbering":{"title":{"offset":1}},"edit_url":"https://github.com/executablebooks/jupyter-book/blob/main/math/reductions/logjump_reduction.ipynb","exports":[{"format":"ipynb","filename":"logjump_reduction.ipynb","url":"/logjump_reduction-53426ee208e6e124996fd81f6ad747f0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Classic Montgomery REDC","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VkXs0sRSP3"}],"identifier":"classic-montgomery-redc","label":"Classic Montgomery REDC","html_id":"classic-montgomery-redc","implicit":true,"key":"WxTnOyZvZO"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Montgomery reduction rewrites a 2·","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xlwF7dV9rr"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"n","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eH2FLaCH8K"}],"key":"aTxNbfBFw3"},{"type":"text","value":"-word integer","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nvKML7IUDu"}],"key":"BIC3kvBfLv"},{"type":"math","value":"c = t = \\sum_{i=0}^{2n-1} t_i \\cdot 2^{64i}","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>c</mi><mo>=</mo><mi>t</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow><mn>2</mn><mi>n</mi><mo>−</mo><mn>1</mn></mrow></munderover><msub><mi>t</mi><mi>i</mi></msub><mo>⋅</mo><msup><mn>2</mn><mrow><mn>64</mn><mi>i</mi></mrow></msup></mrow><annotation encoding=\"application/x-tex\">c = t = \\sum_{i=0}^{2n-1} t_i \\cdot 2^{64i}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.0788em;vertical-align:-1.2777em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8011em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2777em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8747em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8747em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span></span></span>","enumerator":"1","key":"Fzu6Dogfjw"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"into an ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"t3cSvv6exU"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"n","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"VNRkV09bhT"}],"key":"Bk3J3SIpWZ"},{"type":"text","value":"-word residue","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"a31SMqSsMA"},{"type":"break","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"L94zahnHtZ"},{"type":"inlineMath","value":"t \\cdot R^{-1} \\bmod p","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mo>⋅</mo><msup><mi>R</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mtext> </mtext><mo lspace=\"0.22em\" rspace=\"0.22em\"><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow></mo><mtext> </mtext><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">t \\cdot R^{-1} \\bmod p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span>","key":"kyGJVAW8FO"},{"type":"text","value":" with","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"HUHPXBI5W0"}],"key":"T38IxMiJ1X"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":12,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"inlineMath","value":"R = 2^{64n}","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>=</mo><msup><mn>2</mn><mrow><mn>64</mn><mi>n</mi></mrow></msup></mrow><annotation encoding=\"application/x-tex\">R = 2^{64n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span></span></span></span>","key":"YBpBdw2hpJ"},{"type":"text","value":" (so ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"Ohx0qPa0eO"},{"type":"inlineMath","value":"R \\equiv 0 \\pmod{p}","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>≡</mo><mn>0</mn><mspace></mspace><mspace width=\"0.4444em\"/><mo stretchy=\"false\">(</mo><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow><mspace width=\"0.3333em\"/><mi>p</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">R \\equiv 0 \\pmod{p}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span><span class=\"mspace allowbreak\"></span><span class=\"mspace\" style=\"margin-right:0.4444em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.3333em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span></span></span></span>","key":"ECvmtCFQ8e"},{"type":"text","value":"),","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"g9DDaK14x2"}],"key":"v9nHww7pWk"},{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"a single-word constant ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"byuz0MDfkt"},{"type":"inlineMath","value":"\\mu = -p^{-1} \\pmod{2^{64}}","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi><mo>=</mo><mo>−</mo><msup><mi>p</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mspace></mspace><mspace width=\"0.4444em\"/><mo stretchy=\"false\">(</mo><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow><mspace width=\"0.3333em\"/><msup><mn>2</mn><mn>64</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mu = -p^{-1} \\pmod{2^{64}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">−</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace allowbreak\"></span><span class=\"mspace\" style=\"margin-right:0.4444em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.3333em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>","key":"TvaGDr2b3x"},{"type":"text","value":".","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"dLgKxx2Ljn"}],"key":"xwmen1aPy7"}],"key":"j1LHD3RkV3"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"The outer loop runs ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"BmfFSm6ST1"},{"type":"strong","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"once per limb","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"ZCSPcnfpcT"}],"key":"hgShmedrgn"},{"type":"text","value":" (","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"efniwq69vi"},{"type":"inlineCode","value":"i = 0 … n−1","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"U6RthUn3gS"},{"type":"text","value":"):","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"uOdcWLByVy"}],"key":"pWKAxofH1p"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":17,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Pick ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"CJ4AAgbptr"},{"type":"inlineMath","value":"q = (t[i] \\cdot \\mu) \\bmod 2^{64}","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi><mo>=</mo><mo stretchy=\"false\">(</mo><mi>t</mi><mo stretchy=\"false\">[</mo><mi>i</mi><mo stretchy=\"false\">]</mo><mo>⋅</mo><mi>μ</mi><mo stretchy=\"false\">)</mo><mtext> </mtext><mo lspace=\"0.22em\" rspace=\"0.22em\"><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow></mo><mtext> </mtext><msup><mn>2</mn><mn>64</mn></msup></mrow><annotation encoding=\"application/x-tex\">q = (t[i] \\cdot \\mu) \\bmod 2^{64}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">μ</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span></span></span></span>","key":"q7ACPRtC37"},{"type":"text","value":" → forces","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"nMTybdtCOJ"},{"type":"break","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"WZa9sISOjT"},{"type":"inlineMath","value":"t[i] + q \\cdot p \\equiv 0 \\pmod{2^{64}}","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mo stretchy=\"false\">[</mo><mi>i</mi><mo stretchy=\"false\">]</mo><mo>+</mo><mi>q</mi><mo>⋅</mo><mi>p</mi><mo>≡</mo><mn>0</mn><mspace></mspace><mspace width=\"0.4444em\"/><mo stretchy=\"false\">(</mo><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow><mspace width=\"0.3333em\"/><msup><mn>2</mn><mn>64</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">t[i] + q \\cdot p \\equiv 0 \\pmod{2^{64}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6582em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span><span class=\"mspace allowbreak\"></span><span class=\"mspace\" style=\"margin-right:0.4444em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.3333em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>","key":"dCN51w0eDv"},{"type":"text","value":";","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"YMas6GiTs3"}],"key":"Ve21kivP1F"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Add ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"V666zHozDf"},{"type":"inlineMath","value":"q \\cdot p","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi><mo>⋅</mo><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">q \\cdot p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6389em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span>","key":"YxTZyKhp5i"},{"type":"text","value":" into the running array (two inner loops);","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"ebcYaCuc7h"}],"key":"egLMz6DRPb"},{"type":"listItem","spread":true,"position":{"start":{"line":20,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"After the loop, the first ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"U1hvWIh6hl"},{"type":"emphasis","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"n","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"RGkRZtEi9E"}],"key":"LjzrgKpz3W"},{"type":"text","value":" limbs are guaranteed zero","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"UpeGhvQqUU"},{"type":"break","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"mOa4A79yCv"},{"type":"text","value":"→ drop them (divide by ","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"lUgUS2BFBs"},{"type":"inlineMath","value":"R","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span>","key":"ql9y9y9df7"},{"type":"text","value":");","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"ehbS92tcyb"}],"key":"ue3ydMn4p6"},{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"Final conditional subtraction ensures the result ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"qPCyMgSNqS"},{"type":"inlineMath","value":"< p","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>&lt;</mo><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">&lt; p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span>","key":"XJ58psVJmn"},{"type":"text","value":".","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"TKome14IIa"}],"key":"pNqG29sCZ4"}],"key":"oIKvjlH3Mi"},{"type":"paragraph","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"The code below is a pseudocode, parameterised by the constants we set up in the previous cell.","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"JEbArWf2cp"}],"key":"twbYUmssrQ"}],"key":"T4hfR8STUi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def mont_redc(c_words: List[int]) -> List[int]:\n    \"\"\"\n    Classic Montgomery reduction, limb-for-limb.\n    Expects c_words to have length 2*N (little-endian).\n    Returns an n-word little-endian list < p.\n    \"\"\"\n    assert len(c_words) == 2 * N\n    t = c_words.copy()\n\n    for i in range(N):\n        q = (t[i] * MU) & MASK\n\n        # ---- multiply  p * q  ----\n        pq   = [0] * (N + 1)\n        carry = 0\n        for j in range(N):\n            prod   = q * P_WORDS[j] + carry\n            pq[j]  = prod & MASK\n            carry  = prod >> WORD_BITS\n        pq[N] = carry\n\n        # ---- add pq into t[i + ..] ----\n        carry = 0\n        for j in range(N + 1):\n            s        = t[i + j] + pq[j] + carry\n            t[i + j] = s & MASK\n            carry    = s >> WORD_BITS\n\n        # ---- propagate carry further if needed ----\n        k = i + N + 1\n        while carry and k < 2 * N:\n            s     = t[k] + carry\n            t[k]  = s & MASK\n            carry = s >> WORD_BITS\n            k    += 1\n\n    # t now starts with n zeros; slice off the high half\n    lhs = t[N : 2 * N]\n\n    if gte(lhs, P_WORDS[:N]):\n        lhs = sub(lhs, P_WORDS[:N])\n    return lhs\n","key":"vx5ESdBweD"},{"type":"output","id":"JmF_-RikVN-RShos6kJhD","data":[],"key":"RRLbzXebiE"}],"key":"F8pYWmkysM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"From REDC to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u2qujYzmEJ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"LogJump/SOS","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zvS8rvYtgq"}],"key":"gNdg47wXrz"},{"type":"text","value":" — the big idea","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Lz1bnTL9bG"}],"identifier":"from-redc-to-logjump-sos-the-big-idea","label":"From REDC to LogJump/SOS — the big idea","html_id":"from-redc-to-logjump-sos-the-big-idea","implicit":true,"key":"uRN1TB3byE"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Classic Montgomery spends ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tPsLGf24O5"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"one full outer loop per limb","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zr5rLh51go"}],"key":"vyrXM2el2y"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mTj3jzuQqc"},{"type":"break","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WBVK2XzKj6"},{"type":"text","value":"LogJump collapses ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ywKlK4NJvU"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"n − 1","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rkHwoZW4xJ"}],"key":"iS88n2Xlpq"},{"type":"text","value":" of those loops into just three ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T3CHtGFmO6"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ρ-jumps","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fdltDPVXVC"}],"key":"iiFja1aFEY"},{"type":"text","value":" and leaves ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VylJw2XAkU"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"only a single","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QKjSJ8Xmhf"}],"key":"PHTKANEkHW"},{"type":"text","value":" Montgomery iteration at the end.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dasV1L0ieZ"}],"key":"ihUugm4a3J"},{"type":"heading","depth":2,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"1 Pre-compute a “magic” vector ρ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"arnQZftjHi"}],"identifier":"id-1-pre-compute-a-magic-vector","label":"1 Pre-compute a “magic” vector ρ","html_id":"id-1-pre-compute-a-magic-vector","implicit":true,"key":"T233FWOuv2"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"For an ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"Mofhw2dBEa"},{"type":"inlineMath","value":"n = 4","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding=\"application/x-tex\">n = 4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span></span></span></span>","key":"cDKNSMf5E6"},{"type":"text","value":" limb modulus, let","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"CvVrcJiI4b"}],"key":"NB7ZpcfkLz"},{"type":"math","value":"\\rho = 2^{-64} \\bmod p, \\qquad\n\\rho = (\\rho_0, \\rho_1, \\rho_2, \\rho_3)_{\\text{le}} .","position":{"start":{"line":12,"column":1},"end":{"line":15,"column":1}},"html":"<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>ρ</mi><mo>=</mo><msup><mn>2</mn><mrow><mo>−</mo><mn>64</mn></mrow></msup><mtext> </mtext><mo lspace=\"0.22em\" rspace=\"0.22em\"><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow></mo><mtext> </mtext><mi>p</mi><mo separator=\"true\">,</mo><mspace width=\"2em\"/><mi>ρ</mi><mo>=</mo><mo stretchy=\"false\">(</mo><msub><mi>ρ</mi><mn>0</mn></msub><mo separator=\"true\">,</mo><msub><mi>ρ</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>ρ</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><msub><mi>ρ</mi><mn>3</mn></msub><msub><mo stretchy=\"false\">)</mo><mtext>le</mtext></msub><mi mathvariant=\"normal\">.</mi></mrow><annotation encoding=\"application/x-tex\">\\rho = 2^{-64} \\bmod p, \\qquad\n\\rho = (\\rho_0, \\rho_1, \\rho_2, \\rho_3)_{\\text{le}} .</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8641em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.0556em;\"></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ρ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">le</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">.</span></span></span></span></span>","enumerator":"2","key":"suUrBUMOxN"},{"type":"paragraph","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Because ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"ebULhBYxba"},{"type":"inlineMath","value":"2^{64} \\cdot \\rho \\equiv 1 \\pmod{p}","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mn>64</mn></msup><mo>⋅</mo><mi>ρ</mi><mo>≡</mo><mn>1</mn><mspace></mspace><mspace width=\"0.4444em\"/><mo stretchy=\"false\">(</mo><mrow><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">d</mi></mrow><mspace width=\"0.3333em\"/><mi>p</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">2^{64} \\cdot \\rho \\equiv 1 \\pmod{p}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6582em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">ρ</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≡</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span><span class=\"mspace allowbreak\"></span><span class=\"mspace\" style=\"margin-right:0.4444em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathrm\">mod</span></span></span><span class=\"mspace\" style=\"margin-right:0.3333em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span></span></span></span>","key":"ekGGyukyzn"},{"type":"text","value":", multiplying the ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"bwCRyRT7jD"},{"type":"strong","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"low word","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"jq1CxdsB79"}],"key":"ZcK6BjtxsY"},{"type":"text","value":" of any value by ","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"pcq1zLuBoh"},{"type":"inlineMath","value":"\\rho","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding=\"application/x-tex\">\\rho</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">ρ</span></span></span></span>","key":"Fs2Azhc5hX"},{"type":"text","value":" and adding that in at a one-word offset both:","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"kXKgzqtnP1"}],"key":"SmO7Mn1ljO"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":19,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"cancels the low word, ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"JPZ1oepPwg"},{"type":"strong","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"and","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"IVsk4gFLm9"}],"key":"P8F5mWtYpg"}],"key":"dNJLZgciPM"},{"type":"listItem","spread":true,"position":{"start":{"line":20,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"shifts the whole number one limb to the right","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"VzHo7pmBCS"},{"type":"break","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"kdYYhYyBAO"},{"type":"text","value":"(the carry serves as the “lost” high word).","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"un51iOG3dK"}],"key":"c6v76wWvhw"}],"key":"s6NksLdcHt"},{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"This is exactly what each Montgomery outer loop did — but now we get the","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"iLvjtVCvaS"},{"type":"break","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"gjSxgzVd37"},{"type":"text","value":"shift ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"XwLsS2eF3e"},{"type":"strong","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"for free","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"AzPUyDfivY"}],"key":"QThnPU1Wzo"},{"type":"text","value":" once ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"Ee3Qub8S4c"},{"type":"inlineMath","value":"\\rho","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding=\"application/x-tex\">\\rho</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">ρ</span></span></span></span>","key":"bHjOqI3DXt"},{"type":"text","value":" is available.","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"HG9LuRVzSn"}],"key":"jUU30nuEvD"},{"type":"heading","depth":2,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"2 Do three jumps instead of three REDC loops","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"EUAK8jwu21"}],"identifier":"id-2-do-three-jumps-instead-of-three-redc-loops","label":"2 Do three jumps instead of three REDC loops","html_id":"id-2-do-three-jumps-instead-of-three-redc-loops","implicit":true,"key":"idxu9A4H5y"},{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"For a 256-bit number we need to zero and discard the first ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"liEAA26gqU"},{"type":"strong","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"three","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"aDFASouuwo"}],"key":"zTWzenabuo"},{"type":"text","value":" limbs:","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"JHgFGPnucC"}],"key":"kVkL7ivmhQ"}],"key":"AKPzPuh5Mr"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"LogJump Example – Execution Breakdown","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CD00S6RkEO"}],"identifier":"logjump-example-execution-breakdown","label":"LogJump Example – Execution Breakdown","html_id":"logjump-example-execution-breakdown","implicit":true,"key":"xswGEsVXJ3"},{"type":"code","lang":"text","value":"c = [ c0 c1 c2 c3 c4 c5 c6 c7 ]\n     ↓\nstep1: ρ·c0 added one limb up → shift 1  \nstep2: ρ·(new)low added one limb up → shift 1  \nstep3: ρ·(new)low added one limb up → shift 1","position":{"start":{"line":3,"column":1},"end":{"line":9,"column":1}},"key":"rTCoRkj80k"},{"type":"code","lang":"pgsql","value":"After those three jumps the array looks like","position":{"start":{"line":11,"column":1},"end":{"line":13,"column":1}},"key":"rCShXAvA2A"},{"type":"code","lang":"text","value":"[ 0 0 0 r1 r2 r3 r4 ]","position":{"start":{"line":15,"column":1},"end":{"line":17,"column":1}},"key":"FwUwlhql4K"},{"type":"paragraph","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"So we have already divided by ","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"KLT01EiwDC"},{"type":"inlineMath","value":"2^{64 \\cdot 3}","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mrow><mn>64</mn><mo>⋅</mo><mn>3</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">2^{64 \\cdot 3}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">64</span><span class=\"mbin mtight\">⋅</span><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span></span></span></span></span>","key":"chtXcS8sPy"},{"type":"text","value":".","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"bGTQzUH1nj"}],"key":"ynQyDlOsUn"},{"type":"thematicBreak","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"CtUYyCV5Db"},{"type":"heading","depth":2,"position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"3 Finish with ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"lxMm46xyRG"},{"type":"strong","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"children":[{"type":"text","value":"one","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"n6LliKrdCP"}],"key":"FzRTJ7odpV"},{"type":"text","value":" standard Montgomery iteration","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"zGKATxNfSD"}],"identifier":"id-3-finish-with-one-standard-montgomery-iteration","label":"3 Finish with one standard Montgomery iteration","html_id":"id-3-finish-with-one-standard-montgomery-iteration","implicit":true,"key":"YcNxEHFxnv"},{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"Only limb 0 of the remaining slice may still be non-zero.","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"BdAI9n57Y5"},{"type":"break","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"qfaWTLtjth"},{"type":"text","value":"One ordinary REDC loop (with the usual constant ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"oIqQCDJzcN"},{"type":"inlineMath","value":"\\mu","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">μ</span></span></span></span>","key":"sIiIYAeweq"},{"type":"text","value":") clears it and divides by the final ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"MLPN8vL0S1"},{"type":"span","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"2","key":"FgKoOo2P4E"},{"type":"superscript","children":[{"type":"text","value":"64","key":"PZZ15ptlNv"}],"key":"sBJs74vbJt"}],"key":"Cm9oYd1LsR"},{"type":"text","value":", leaving exactly four words.","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"rE9tp9Vgvl"},{"type":"break","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"VY7dYU4rKh"},{"type":"text","value":"A compare-and-subtract with ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"WKUd2cGw33"},{"type":"emphasis","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"p","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"t9Ihsbj20H"}],"key":"yFNylgMC5L"},{"type":"text","value":" is the last step.","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"iHy7lxPMjg"}],"key":"W6gpQULq23"},{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"strong","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"Result: multiplies saved","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"YcTGTpJ87o"}],"key":"FP1zlPjYdO"}],"key":"rAopTZwKjT"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":31,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"text","value":"Classic REDC → ","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"nWR2ZYtQSr"},{"type":"inlineMath","value":"n^2 + n","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n^2 + n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>","key":"Q0fTwv6tiU"},{"type":"text","value":" word-multiplies","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"xTSC6K5q0K"}],"key":"UUmkKjhaxI"},{"type":"listItem","spread":true,"position":{"start":{"line":32,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"LogJump/SOS → ","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"VnqaB58Kaf"},{"type":"inlineMath","value":"n^2 + 1","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">n^2 + 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>","key":"x49nDOF9YF"},{"type":"text","value":" word-multiplies","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"B64lLwf0fV"}],"key":"LtXzmDhxaK"}],"key":"haTD447SmL"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"For secp256k1 (","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"ymOtll88MZ"},{"type":"emphasis","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"n = 4","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"YzbfrhE58F"}],"key":"McaSB0YYss"},{"type":"text","value":"), that is:","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"YjQkbYv70W"},{"type":"break","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"acll4pN5Wv"},{"type":"text","value":"20 → 17 multiplies — a ~15% cut.","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"VlOf6Ei6v2"}],"key":"C10q9gJzGX"},{"type":"paragraph","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"text","value":"The next cells turn this description into code.","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"nATfIw0m2k"}],"key":"KCYYc2H7tG"}],"key":"TpQDCmZ1Sk"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"LogJump/SOS implementation (64-bit limbs, n = 4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WLeF5Vu2RA"}],"identifier":"logjump-sos-implementation-64-bit-limbs-n-4","label":"LogJump/SOS implementation (64-bit limbs, n = 4)","html_id":"logjump-sos-implementation-64-bit-limbs-n-4","implicit":true,"key":"Ijqs5z0jYh"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Below we define:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WnWm1S6oWD"}],"key":"LCXgBQ8W3f"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"calc_m(low)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qAJiSoUSrl"}],"key":"wJdfb6PdNH"},{"type":"text","value":" – multiplies a single limb ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ZBiNma0Ew4"},{"type":"inlineCode","value":"low","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sc0hgHFqUc"},{"type":"text","value":" by the pre-computed\nρ-vector and returns the 5-word result.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"MSUqsWOohx"}],"key":"CRuHSbWRAg"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"inlineCode","value":"mul_logjumps_sos(c)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"xsVLrLqsJP"}],"key":"G897qNcTq2"},{"type":"text","value":" – performs three ρ-jumps followed by one\nclassic Montgomery iteration, returning a 4-limb residue < p.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"AseWU47qOA"}],"key":"yubqoaneF2"}],"key":"MZ48Wdwsdp"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"All constants (","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"xQ30JxwCa8"},{"type":"inlineCode","value":"ρ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"c3SWbsNUgn"},{"type":"text","value":", ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"xCEHmL7bwH"},{"type":"inlineCode","value":"μ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"QhywdiTMPM"},{"type":"text","value":", ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"JGh9bh7gjF"},{"type":"inlineCode","value":"p","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"MtsJcbsLwN"},{"type":"text","value":") come from the setup cell so that the\ncomparison with ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"HYYs0KrUL6"},{"type":"inlineCode","value":"mont_redc","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"kIAqTK7MeX"},{"type":"text","value":" is apples-to-apples.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"Vn9ttXPVkt"}],"key":"QxaGzGw1E2"}],"key":"Vi7ZB27NJW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def calc_m(low: int) -> list[int]:\n    carry, m = 0, [0]*6\n    for i in range(5):\n        prod   = low * RHO_WORDS[i] + carry\n        m[i]   = prod & MASK\n        carry  = prod >> WORD_BITS\n    m[5] = carry\n    return m\n\ndef mul_logjumps_sos(c_words: list[int]) -> list[int]:\n    R = [0]*8\n\n    # jump #1\n    m, carry = calc_m(c_words[0]), 0\n    for i in range(6):\n        s = c_words[i+1] + m[i] + carry\n        R[i], carry = s & MASK, s >> WORD_BITS\n    s = c_words[6] + carry\n    R[5], carry = s & MASK, s >> WORD_BITS\n    s = c_words[7] + carry\n    R[6], carry = s & MASK, s >> WORD_BITS\n    R[7] = carry\n\n    # jump #2\n    m, carry = calc_m(R[0]), 0\n    for i in range(6):\n        s = R[i+1] + m[i] + carry\n        R[i], carry = s & MASK, s >> WORD_BITS\n    s = R[6] + carry\n    R[5], carry = s & MASK, s >> WORD_BITS\n    R[6] = carry\n    R[7] = 0\n\n    # jump #3\n    m, carry = calc_m(R[0]), 0\n    for i in range(6):\n        s = R[i+1] + m[i] + carry\n        R[i], carry = s & MASK, s >> WORD_BITS\n    R[5] = carry\n    R[6] = R[7] = 0\n\n    # one Montgomery iteration\n    q = (R[0] * MU) & MASK\n    pq, carry = [0]*6, 0\n    for i in range(5):\n        prod      = q * U64_P[i] + carry\n        pq[i], carry = prod & MASK, prod >> WORD_BITS\n    pq[5] = carry\n\n    carry = 0\n    for i in range(6):\n        s = R[i] + pq[i] + carry\n        R[i], carry = s & MASK, s >> WORD_BITS\n    idx = 6\n    while carry and idx < 8:\n        s = R[idx] + carry\n        R[idx], carry = s & MASK, s >> WORD_BITS\n        idx += 1\n\n    out = R[1:5]\n    if gte(out, P_WORDS[:4]):\n        out = sub(out, P_WORDS[:4])\n    return out\n","key":"ihoFrN8O2y"},{"type":"output","id":"4V6ovzrze7lno7qorS56J","data":[],"key":"G8hHmLxESk"}],"key":"Emz0Pp5TL0"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Official limb-loops vs. big-int back-end","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MA0sTPzjMc"}],"identifier":"official-limb-loops-vs-big-int-back-end","label":"Official limb-loops vs. big-int back-end","html_id":"official-limb-loops-vs-big-int-back-end","implicit":true,"key":"xR7UlJvPOu"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Variant","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qB3iOga546"}],"key":"nJ8cCDm4Wy"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"What it actually does","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eXTEFbVyRI"}],"key":"xfb5ljWGzv"}],"key":"pSi0dHYoC6"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Official limb loops","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"AhkiX0sXeT"}],"key":"S16Jn38TG1"}],"key":"AluNWaVOGN"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"manipulates four 64-bit limbs with explicit Python ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kYXacpkUCJ"},{"type":"inlineCode","value":"for","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vRdk5CbS3Z"},{"type":"text","value":"-loops, carry handling, and per-limb multiplies.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"y0PQ42jTVE"}],"key":"KcswMJ4faw"}],"key":"KUVHedZD5D"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Big-int / GMP","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"uxNP9i8HJp"}],"key":"p7s7kmqacF"}],"key":"Fb66Fs3JIC"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Treats the same 256-bit number as one large Python ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"gmyjONic6h"},{"type":"inlineCode","value":"int","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"UoBV98huUO"},{"type":"text","value":" (or ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"TmiTZSor7Y"},{"type":"inlineCode","value":"gmpy2.mpz","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ky2TLbg5rU"},{"type":"text","value":"). Each limb step becomes a single C-level bigint multiply, so the benchmark measures only the difference in multiplication count.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"uchItDnK09"}],"key":"oasMNKYwit"}],"key":"fpqS7rqJnG"}],"key":"NEeGQChjt8"},{"type":"blockquote","position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Limb loops incur heavy interpreter overhead, hiding LogJump’s saving.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"FWq5ipsSy5"},{"type":"break","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"cUK5reCZda"},{"type":"text","value":"Big-int mode pushes work into optimized C code, revealing the relative speed-up.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"bQOHUikxqw"}],"key":"d5Bbzg3YFQ"}],"key":"cS7TjP2A6H"}],"key":"Id5plzprjP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import random, timeit, importlib.util\nfrom typing import List\n\nWORD_BITS = 64\nMASK = (1 << WORD_BITS) - 1\nP = 0x30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd47\nN, R = 4, 1 << (WORD_BITS * 4)\nMU0 = (-pow(P, -1, 1 << WORD_BITS)) & MASK\n\nhas_gmp = bool(importlib.util.find_spec(\"gmpy2\"))\n_int = __import__(\"gmpy2\").mpz if has_gmp else int\n\nchoice = input(\"Choose implementation: 1 = official limb loops, 2 = big-int > \").strip()\nuse_official = (choice != \"2\")\n\ndef to_words(x, m=2*N): return [(x >> (WORD_BITS*i)) & MASK for i in range(m)]\ndef from_words(ws): return sum(w << (WORD_BITS*i) for i, w in enumerate(ws))\ndef gte(a, b): return a[::-1] >= b[::-1]\ndef sub(a, b):\n    out, borrow = [], 0\n    for ai, bi in zip(a, b):\n        t = ai - bi - borrow\n        out.append((t + (1<<WORD_BITS)) & MASK if t < 0 else t & MASK)\n        borrow = t < 0\n    return out\n\nP_WORDS = to_words(P, N) + [0]\nRHO_WORDS = to_words(pow(2, -WORD_BITS, P), N) + [0]\n\ndef mont_redc(c):\n    t = c.copy()\n    for i in range(N):\n        q = (t[i] * MU0) & MASK\n        pq, carry = [0]*(N+1), 0\n        for j in range(N):\n            prod = q * P_WORDS[j] + carry\n            pq[j], carry = prod & MASK, prod >> WORD_BITS\n        pq[N] = carry\n        carry = 0\n        for j in range(N+1):\n            s = t[i+j] + pq[j] + carry\n            t[i+j], carry = s & MASK, s >> WORD_BITS\n        k = i+N+1\n        while carry and k < 2*N:\n            s = t[k] + carry\n            t[k], carry = s & MASK, s >> WORD_BITS\n            k += 1\n    lhs = t[N:2*N]\n    if gte(lhs, P_WORDS[:N]): lhs = sub(lhs, P_WORDS[:N])\n    return lhs\n\ndef calc_m(low):\n    carry, m = 0, [0]*6\n    for i in range(5):\n        prod = low * RHO_WORDS[i] + carry\n        m[i], carry = prod & MASK, prod >> WORD_BITS\n    m[5] = carry\n    return m\n\ndef mul_logjumps_sos(c):\n    Rv = [0]*8\n    m, carry = calc_m(c[0]), 0\n    for i in range(6):\n        s = c[i+1] + m[i] + carry\n        Rv[i], carry = s & MASK, s >> WORD_BITS\n    s = c[6] + carry; Rv[5], carry = s & MASK, s >> WORD_BITS\n    s = c[7] + carry; Rv[6], carry = s & MASK, s >> WORD_BITS\n    Rv[7] = carry\n    for _ in range(2):\n        m, carry = calc_m(Rv[0]), 0\n        for i in range(6):\n            s = Rv[i+1] + m[i] + carry\n            Rv[i], carry = s & MASK, s >> WORD_BITS\n        s = Rv[6] + carry; Rv[5], carry = s & MASK, s >> WORD_BITS\n        Rv[6], Rv[7] = carry, 0\n    q = (Rv[0] * MU0) & MASK\n    pq, carry = [0]*6, 0\n    for i in range(5):\n        prod = q * P_WORDS[i] + carry\n        pq[i], carry = prod & MASK, prod >> WORD_BITS\n    pq[5] = carry\n    carry = 0\n    for i in range(6):\n        s = Rv[i] + pq[i] + carry\n        Rv[i], carry = s & MASK, s >> WORD_BITS\n    idx = 6\n    while carry and idx < 8:\n        s = Rv[idx] + carry\n        Rv[idx], carry = s & MASK, s >> WORD_BITS\n        idx += 1\n    out = Rv[1:5]\n    if gte(out, P_WORDS[:4]): out = sub(out, P_WORDS[:4])\n    return out\n\ndef mont_big(x):\n    for _ in range(N):\n        m = (x & MASK) * MU0 & MASK\n        x = (x + m * P) >> WORD_BITS\n    return x - P if x >= P else x\n\ndef logj_big(x):\n    for _ in range(N-1):\n        m = (x & MASK) * MU0 & MASK\n        x = (x + m * P) >> WORD_BITS\n    m = (x & MASK) * MU0 & MASK\n    x = (x + m * P) >> WORD_BITS\n    return x - P if x >= P else x\n\nif use_official:\n    mont_reduce_int  = lambda z: from_words(mont_redc(to_words(int(z), 2*N)))\n    logjump_reduce_int = lambda z: from_words(mul_logjumps_sos(to_words(int(z), 2*N)))\nelse:\n    mont_reduce_int, logjump_reduce_int = mont_big, logj_big\n\nprint(f\"Backend    : {'GMP (gmpy2)' if has_gmp else 'Python int'}\")\nprint(f\"Variant    : {'official limb loops' if use_official else 'big-int'}\\n\")\n\nrng = random.SystemRandom()\nxs = [_int(rng.randrange(0, P * R)) for _ in range(10_000)]\nsingle_m = timeit.timeit(\"mont_reduce_int(xs[0])\", globals=globals(), number=100_000)\nsingle_l = timeit.timeit(\"logjump_reduce_int(xs[0])\", globals=globals(), number=100_000)\n\nsetup = \"from __main__ import mont_reduce_int, logjump_reduce_int, xs\"\nstmtm = \"for x in xs: mont_reduce_int(x)\"\nstmtl = \"for x in xs: logjump_reduce_int(x)\"\nbest_m = min(timeit.repeat(stmtm, setup=setup, repeat=10, number=1))\nbest_l = min(timeit.repeat(stmtl, setup=setup, repeat=10, number=1))\nns_m = best_m * 1e9 / len(xs)\nns_l = best_l * 1e9 / len(xs)\n\nprint(f\"[micro]    Mont  {single_m*1e6/100_000:8.3f} µs   LogJump {single_l*1e6/100_000:8.3f} µs\")\nprint(f\"[batch]    Mont  {ns_m:8.1f} ns/op   LogJump {ns_l:8.1f} ns/op   speed-up {ns_m/ns_l:4.2f}×\")","key":"o0Lrv2eQzk"},{"type":"output","id":"RqoiUqszMHDm_UFa_5GJw","data":[{"name":"stdin","output_type":"stream","text":"Choose implementation: 1 = official limb loops, 2 = big-int >  2\n"},{"name":"stdout","output_type":"stream","text":"Backend    : GMP (gmpy2)\nVariant    : big-int\n\n[micro]    Mont     2.051 µs   LogJump    2.044 µs\n[batch]    Mont    2076.4 ns/op   LogJump   2060.3 ns/op   speed-up 1.01×\n"}],"key":"nTv5RgUnlZ"}],"key":"oinznLcolt"}],"key":"nG527gEL32"},"references":{"cite":{"order":[],"data":{}}}}
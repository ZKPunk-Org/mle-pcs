{"version":2,"kind":"Notebook","sha256":"ba9ea168444b586ff8337e83ba68a3e088e1e179a359dda77585189e3316f4c0","slug":"src.deepfold","location":"/src/deepfold.ipynb","dependencies":[],"frontmatter":{"title":"Commit phase","content_includes_title":true,"kernelspec":{"name":"SageMath-10.4","display_name":"SageMath 10.4","language":"sage"},"github":"https://github.com/executablebooks/jupyter-book","numbering":{"title":{"offset":1}},"edit_url":"https://github.com/executablebooks/jupyter-book/blob/main/src/deepfold.ipynb","exports":[{"format":"ipynb","filename":"deepfold.ipynb","url":"/deepfold-03bbfdbf2ea23623b0be0662513778bc.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"F193 = GF(64*3+1)\nTWO_ADICITY = 6\nORDER = 64*3+1\nMULTIPLICATIVE_GENERATOR = F193.primitive_element()\nROOT_OF_UNITY = F193(MULTIPLICATIVE_GENERATOR**3)\nF193.primitive_element()\nR193.<X, A, B, X0, X1, X2, X3, X4, X5, A0, A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15> = PolynomialRing(F193)","key":"ermi7rDZKc"},{"type":"output","id":"WJnfT7uHpSN_whbxL8_ja","data":[],"key":"H0TE9ipPYt"}],"key":"YjtMmqrC26"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"from typing import Union, Optional, TypeVar\nfrom random import randint, Random\nfrom utils import prime_field_inv, is_power_of_two, log_2, next_power_of_two","key":"X6nySZNUbp"},{"type":"output","id":"yaop5up_2Z_rtr7stbyhp","data":[],"key":"muh7kdSnWP"}],"key":"x7Be6D18bg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"class Fp:\n    field_modulus = ORDER\n\n    ROOT_OF_UNITY = ROOT_OF_UNITY\n    MULTIPLICATIVE_GENERATOR = MULTIPLICATIVE_GENERATOR\n    TWO_ADICITY = TWO_ADICITY\n\n    def __init__(self, val: Integer | int) -> None:\n        if self.field_modulus is None:\n            raise AttributeError(\"Field Modulus hasn't been specified\")\n\n        if isinstance(val, Fp):\n            self.n = val.n % self.field_modulus\n        elif isinstance(val, Integer):\n            self.n = val % self.field_modulus\n        elif Integer(val) == Integer(val):\n            self.n = Integer(val) % self.field_modulus\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(val))\n            )\n\n    def __add__(self, other: Union[Integer, \"Fp\"]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)((self.n + on) % self.field_modulus)\n\n    def __mul__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)((self.n * on) % self.field_modulus)\n\n    def __rmul__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        return self * other\n\n    def __radd__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        return self + other\n\n    def __rsub__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)((on - self.n) % self.field_modulus)\n\n    def __sub__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)((self.n - on) % self.field_modulus)\n\n    def __div__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)(\n            self.n * prime_field_inv(on, self.field_modulus) % self.field_modulus\n        )\n\n    def __truediv__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        return self.__div__(other)\n\n    def __rdiv__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        if isinstance(other, Fp):\n            on = other.n\n        elif isinstance(other, Integer):\n            on = other\n        elif Integer(other) == Integer(other):\n            on = Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n        return type(self)(\n            prime_field_inv(self.n, self.field_modulus) * on % self.field_modulus\n        )\n\n    def __rtruediv__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n        return self.__rdiv__(other)\n\n    # def __pow__(self, other: Union[\"Fp\", Integer]) -> \"Fp\":\n    #     if other == 0:\n    #         return type(self)(1)\n    #     elif other == 1:\n    #         return type(self)(self.n)\n    #     elif other % 2 == 0:\n    #         return (self * self) ** (other // 2)\n    #     else:\n    #         return ((self * self) ** (other // 2)) * self\n\n    def __eq__(self, other: Union[\"Fp\", Integer]) -> bool:\n        if isinstance(other, Fp):\n            return self.n == other.n\n        elif isinstance(other, Integer):\n            return self.n == other\n        elif Integer(other) == Integer(other):\n            return self.n == Integer(other)\n        else:\n            raise TypeError(\n                \"Expected an int or Fp object, but got object of type {}\"\n                .format(type(other))\n            )\n\n    def __ne__(self, other: Union[\"Fp\", Integer]) -> bool:\n        return not self == other\n\n    def __neg__(self) -> \"Fp\":\n        return type(self)(-self.n)\n\n    def __str__(self) -> str:\n        return self.repr()\n        \n    def __repr__(self) -> str:\n        return self.repr()\n    \n    # Override the default (inefficient) __pow__ function in py_ecc.fields.field_elements.FQ\n    def __pow__(self: \"Fp\", other: int) -> \"Fp\":\n        return type(self)(pow(self.n, other, self.field_modulus))\n    \n    # def __repr__(self) -> str:\n    #     return repr(self.n)\n\n    def __int__(self) -> int:\n        return self.n\n\n    @classmethod\n    def one(cls) -> \"Fp\":\n        return cls(1)\n\n    @classmethod\n    def zero(cls) -> \"Fp\":\n        return cls(0)\n    \n    @classmethod\n    def neg_one(cls) -> \"Fp\":\n        return cls(cls.field_modulus - 1)\n\n    @classmethod\n    def rand(cls, rndg: Optional[Random] = None) -> \"Fp\":\n        if rndg is None:\n            return cls(randint(1, cls.field_modulus - 1))\n        return cls(rndg.randint(1, cls.field_modulus - 1))\n    \n    @classmethod\n    def random(cls) -> \"Fp\":\n        return cls.rand()\n    \n    @classmethod\n    def rands(cls, rndg: Random, n: int) -> list[\"Fp\"]:\n        return [cls(rndg.randint(1, cls.field_modulus - 1)) for _ in range(n)]\n    \n    @classmethod\n    def from_bytes(cls, b: bytes) -> \"Fp\":\n        i = int.from_bytes(b, \"big\")\n        return cls(i)\n    \n    def inv(self) -> \"Fp\":\n        return Fp(prime_field_inv(self.n, self.field_modulus))\n    \n    def repr(self) -> str:\n        k = self.field_modulus // 2\n        if self.n < k:\n            return f\"{self.n}\"\n        else:\n            return f\"-{self.field_modulus - self.n}\"\n        \n    def exp(self: \"Fp\", other: int) -> \"Fp\":\n        return type(self)(pow(self.n, other, self.field_modulus))\n    \n    @classmethod\n    def compute_root_of_unity(cls) -> \"Fp\":\n        return cls(pow(cls.MULTIPLICATIVE_GENERATOR, ((cls.field_modulus - 1) // 2 ** cls.TWO_ADICITY), cls.field_modulus))\n    \n    @classmethod\n    def root_of_unity(cls) -> \"Fp\":\n        return cls(cls.ROOT_OF_UNITY)\n    \n    @classmethod\n    def multiplicative_generator(cls) -> \"Fp\":\n        return cls(cls.MULTIPLICATIVE_GENERATOR)\n\n    @classmethod\n    def nth_root_of_unity(cls, n: int) -> \"Fp\":\n        assert is_power_of_two(n), \"n must be a power of two\"\n        return cls(pow(cls.ROOT_OF_UNITY, 2**(cls.TWO_ADICITY - log_2(n)), cls.field_modulus))","key":"NnvFNhT88s"},{"type":"output","id":"TzdC5-0DRl1WtArzPCRfP","data":[],"key":"nHpxbGbV7y"}],"key":"nxKywJU2Kz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"from unipoly2 import UniPolynomial, UniPolynomialWithFft, bit_reverse_permutation\nfrom mle2 import MLEPolynomial\nUniPolynomialWithFft.set_field_type(Fp)\nMLEPolynomial.set_field_type(Fp)\nfrom merkle import MerkleTree","key":"SGhZkzO7Ln"},{"type":"output","id":"57SexAyewQzp1JFUcoJ2v","data":[],"key":"YEUaw4Kb4j"}],"key":"cZoUkJhVF9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f_mle = MLEPolynomial([Fp(1), Fp(3), Fp(2), Fp(1),\n                    Fp(2), Fp(-2), Fp(1), Fp(2)], 3)\nf_cm = MerkleTree(f_mle.evals)\nus = [Fp(2), Fp(-1), Fp(2)]\nv = f_mle.evaluate(us)\nv, f_cm.root","key":"PekZsS4MNp"},{"type":"output","id":"rnOdbiMv57_uaT3H-KT-X","data":[{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/plain":{"content":"(-40, 'c86117467dc48f44adcbdff0f6ccfd5e1edfbf358ff48efe3441f2cb8b34aca2')","content_type":"text/plain"}}}],"key":"YnJ8jvi5iN"}],"key":"lUEWmAbKap"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"def rs_encode(f: list[Field], coset: Field, blowup_factor: int) -> list[Field]:\n    n = next_power_of_two(len(f))\n    N = n * blowup_factor\n\n    omega_Nth = Fp.nth_root_of_unity(N)\n    # print(f\"omega_Nth = {omega_Nth}\")\n    k = log_2(N)\n    # print(f\"n = {n}, N = {N}, k = {k}\")\n    vec = f + [Fp.zero()] * (N - len(f))\n    # print(f\"vec = {vec}, len(vec) = {len(vec)}\")\n    return UniPolynomialWithFft.fft_coset_rbo(vec, coset, k, omega=omega_Nth)\n     ","key":"ioCYkdw574"},{"type":"output","id":"73WLjINnv5eax9Q0XGs0O","data":[],"key":"QiQYUJl9hR"}],"key":"U8aRw0J9Dm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f = f_mle.evals\nalpha = Fp(2)\nf_len = len(f)\ng = Fp.multiplicative_generator()\nblowup_factor = 2\nf_code_len = f_len * blowup_factor\nprint(f\"f_code_len = {f_code_len}, g={g}, blowup_factor={blowup_factor}\")","key":"JwQj3aK8dk"},{"type":"output","id":"0ZS5lKx4k2jdhFaK3pAEK","data":[{"name":"stdout","output_type":"stream","text":"f_code_len = 16, g=5, blowup_factor=2\n"}],"key":"zu2wdID3Ek"}],"key":"PzhEw1Irtm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Commit phase","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"olqEKblO6t"}],"identifier":"commit-phase","label":"Commit phase","html_id":"commit-phase","implicit":true,"key":"dzqNmg2Zuw"}],"key":"tT2NEYWdsw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"debug = 2\ntwiddles = UniPolynomialWithFft.precompute_twiddles_for_fft(f_code_len, is_bit_reversed=True)\ncoset = Fp.multiplicative_generator()","key":"wRizOMzsU0"},{"type":"output","id":"SBVzvdYU2VD8cqrRRSYzW","data":[],"key":"xSp5V4rv7z"}],"key":"mVgtzy3M5e"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f = f_mle.evals.copy()\n\n# Sumcheck Round 0\n\neq = MLEPolynomial.eqs_over_hypercube(us)\nn = len(f)\nhalf = n >> 1\nsum0 = v\nv, f, eq","key":"pj0sLb0D5G"},{"type":"output","id":"KdGHRY9v9yGLcCUax-zaw","data":[{"output_type":"execute_result","execution_count":9,"metadata":{},"data":{"text/plain":{"content":"(-40, [1, 3, 2, 1, 2, -2, 1, 2], [2, -4, -1, 2, -4, 8, 2, -4])","content_type":"text/plain"}}}],"key":"eSJcxAbu1V"}],"key":"owsTlgwdsZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"alpha = Fp(31)","key":"oChLBMhdgX"},{"type":"output","id":"_fQ0aSM0V0_KK1TXKTQGZ","data":[],"key":"lLtTQidxGF"}],"key":"i2zmVyBGan"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"def compute_alpha_powers(alpha: Fp, n: int) -> list[Fp]:\n    return [alpha**(2**i) for i in range(n)]\nalpha_powers = compute_alpha_powers(alpha, 3)\nalpha_powers","key":"BknjimL4Gp"},{"type":"output","id":"XaI3TvncFsMbrQwRFhP-K","data":[{"output_type":"execute_result","execution_count":11,"metadata":{},"data":{"text/plain":{"content":"[31, -4, 16]","content_type":"text/plain"}}}],"key":"aIoR9mqPf2"}],"key":"PvOucxNACA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"def fold(f: list[Fp], r: Fp) -> list[Fp]:\n    n = len(f)\n    assert n % 2 == 0, f\"n = {n}, n must be even\"\n    half = n >> 1\n    f_even = f[::2]\n    f_odd = f[1::2]\n    return [f_even[i] + r * (f_odd[i] - f_even[i]) for i in range(half)]\nfold([A0, A1, A2, A3, A4, A5, A6, A7], X0)","key":"wezPCruTwb"},{"type":"output","id":"NjuR0fhVt13MWWd1A90Ve","data":[{"output_type":"execute_result","execution_count":40,"metadata":{},"data":{"text/plain":{"content":"[-X0*A0 + X0*A1 + A0,\n -X0*A2 + X0*A3 + A2,\n -X0*A4 + X0*A5 + A4,\n -X0*A6 + X0*A7 + A6]","content_type":"text/plain"}}}],"key":"eQyQ1KsjHE"}],"key":"UwZjS1BuLR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"def expanded_partial_evaluate(f: list[Fp], us: list[Fp]) -> list[Fp]:\n    \"\"\"\n    Evaluate mle polynomial *partially* from x_{n-1}, x_{n-2}, ..., x_{n-k}\n    \"\"\"\n    k, n = len(us), len(f)\n    assert n == 2**k, f\"n = {n}, k = {k}\"\n\n    rs, e = [], f.copy()\n    half = n >> 1\n    for i in range(k):\n        e_low, e_high = e[:half], e[half:]\n        e = [e_low[j] + us[k-i-1] * (e_high[j] - e_low[j]) for j in range(half)]\n        rs += e\n        half >>= 1\n    return rs\n\nexpanded_partial_evaluate([A0, A1, A2, A3], [X0, X1])","key":"tzSPVf2k81"},{"type":"output","id":"NWfk_b4Nkk3WCC3Zn6T1i","data":[{"output_type":"execute_result","execution_count":72,"metadata":{},"data":{"text/plain":{"content":"[-X1*A0 + X1*A2 + A0,\n -X1*A1 + X1*A3 + A1,\n X0*X1*A0 - X0*X1*A1 - X0*X1*A2 + X0*X1*A3 - X0*A0 - X1*A0 + X0*A1 + X1*A2 + A0]","content_type":"text/plain"}}}],"key":"YwRMNhZI4Z"}],"key":"ccXyt4CA55"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"expanded_partial_evaluate([Fp(1), Fp(2), Fp(3), Fp(4)], [Fp(3), Fp(2)])","key":"bGP2sM5asM"},{"type":"output","id":"NXcNoBbtVHb51cZgZ6kL1","data":[{"output_type":"execute_result","execution_count":73,"metadata":{},"data":{"text/plain":{"content":"[5, 6, 8]","content_type":"text/plain"}}}],"key":"dk9QsbuITi"}],"key":"Kn061LJdw0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"MLEPolynomial([Fp(1), Fp(2), Fp(3), Fp(4)], 2).evaluate([Fp(3), Fp(2)])","key":"c8ep0Tvd2R"},{"type":"output","id":"tkVwhv8TUsjBSO24ht1jH","data":[{"output_type":"execute_result","execution_count":74,"metadata":{},"data":{"text/plain":{"content":"8","content_type":"text/plain"}}}],"key":"k1zPU8qwrz"}],"key":"GTy5j7kfAY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"expanded_partial_evaluate([Fp(1), Fp(2), Fp(3), Fp(4), Fp(5), Fp(6), Fp(7), Fp(8)], [Fp(4), Fp(2), Fp(3)])","key":"rsijiXBKFC"},{"type":"output","id":"yWXemeQw7ZVjiCKozrklr","data":[{"output_type":"execute_result","execution_count":75,"metadata":{},"data":{"text/plain":{"content":"[13, 14, 15, 16, 17, 18, 21]","content_type":"text/plain"}}}],"key":"GI657xeAFl"}],"key":"YIT4EbJ6Tr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"MLEPolynomial([Fp(1), Fp(2), Fp(3), Fp(4), Fp(5), Fp(6), Fp(7), Fp(8)], 3).evaluate([Fp(4), Fp(2), Fp(3)])","key":"qXrWaB4ELk"},{"type":"output","id":"eNwijAcWX7ktbPFL20FHF","data":[{"output_type":"execute_result","execution_count":76,"metadata":{},"data":{"text/plain":{"content":"21","content_type":"text/plain"}}}],"key":"qTyBmoen0t"}],"key":"m5FWtekTlh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f_at_alpha = f_mle.evaluate(alpha_powers)\nf_at_alpha\n","key":"L8vMSebzKX"},{"type":"output","id":"_oxvx7Z8_FTXB0n2ClprE","data":[{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{"text/plain":{"content":"62","content_type":"text/plain"}}}],"key":"bBkHQzZ6CC"}],"key":"iKsInJOwj4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# FRI Round 0\n\nf0_code = rs_encode(f, coset, 2)\nif debug > 1:\n    print(f\"P> check f0_code\")\n    f_orig_evals = bit_reverse_permutation(f0_code)\n    f_orig_coeffs = UniPolynomialWithFft.ifft_coset(f_orig_evals, coset, log_2(f_code_len))\n    f_orig = UniPolynomial(f_orig_coeffs)\n    assert f_orig.coeffs == f, f\"f_orig != f0, f_orig = {f_orig.coeffs}, f = {f}\"\n    print(f\"P> check f0_code passed\")","key":"aKj3vFOcVI"},{"type":"output","id":"nP_Yop4nAuBmsM0B5bx_e","data":[{"name":"stdout","output_type":"stream","text":"P> check f0_code\nP> check f0_code passed\n"}],"key":"IcZ1WQUk6O"}],"key":"MZmSBjSZsy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"alpha0 = Fp(32)\nalpha0_powers = compute_alpha_powers(alpha0, 3)\nalpha0_powers","key":"DPa1efgR2A"},{"type":"output","id":"F8w5BqBEl9qTcYbiwo7b-","data":[{"output_type":"execute_result","execution_count":16,"metadata":{},"data":{"text/plain":{"content":"[32, 59, 7]","content_type":"text/plain"}}}],"key":"ETIftirF0v"}],"key":"onbp5VKUN8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 1\n\nf0_even = f[::2]\nf0_odd = f[1::2]\nf0_even_mle = MLEPolynomial(f0_even, f_mle.num_var-1)\nf0_odd_mle = MLEPolynomial(f0_odd, f_mle.num_var-1)\n\n# construct hz(X): hz(X) = f(X, u1, u2,...)\nhz_at_0 = f0_even_mle.evaluate(us[1:])\nhz_at_1 = f0_odd_mle.evaluate(us[1:])\nhz = [hz_at_0, hz_at_1]\n\nassert (UniPolynomial.evaluate_from_evals(hz, us[0], [Fp(0), Fp(1)])) == v, \\\n    f\"hz(us[0]) = {UniPolynomial.evaluate_from_evals(hz, us[0])}, v = {v}\"","key":"qkmqOVMrsu"},{"type":"output","id":"KV8AK_zqe9d7w4lb0Zu6N","data":[],"key":"yYVSUbpalm"}],"key":"kwCeYi1Ja3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# alpha0 = Fp.rand()\nr0 = Fp(-30)\nr0","key":"InZNXSCyJk"},{"type":"output","id":"HbpL5k1EyfMnibdujcbgM","data":[{"output_type":"execute_result","execution_count":18,"metadata":{},"data":{"text/plain":{"content":"-30","content_type":"text/plain"}}}],"key":"TQiDxoRgJ1"}],"key":"Kd3VIbmeUZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck fold \n\nf1 = [(Fp(1) - r0) * f0_even[i] + r0 * f0_odd[i] for i in range(half)]\n\n# compute the new sum = h(r0)\nhz_r0 = UniPolynomial.evaluate_from_evals(hz, r0, [Fp(0), Fp(1)])","key":"YzJWVLi8cb"},{"type":"output","id":"ZdkAl2JFO1VuVVzi8_PFg","data":[],"key":"kq3otC5kJO"}],"key":"xj2fUoGWBJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"half >>= 1","key":"AhEHlILJue"},{"type":"output","id":"_vjHkA85TTXxyLPdRQoYO","data":[],"key":"wS2kK2NbzL"}],"key":"DStj0Fv4Jl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 2\n\nf1_even = f1[::2]\nf1_odd = f1[1::2]\nf1_even_mle = MLEPolynomial(f1_even, f_mle.num_var-2)\nf1_odd_mle = MLEPolynomial(f1_odd, f_mle.num_var-2)\n\n# construct hz(X): hz(X) = f1(X, u1, u2,...)\nhz_at_0 = f1_even_mle.evaluate(us[2:])\nhz_at_1 = f1_odd_mle.evaluate(us[2:])\nhz = [hz_at_0, hz_at_1]\n\nassert (UniPolynomial.evaluate_from_evals(hz, us[1], [Fp(0), Fp(1)])) == hz_r0, \\\n    f\"hz(us[1]) = {UniPolynomial.evaluate_from_evals(hz, us[1])}, hz_r0 = {hz_r0}\"\n","key":"ZiHwGmHzwh"},{"type":"output","id":"B8J-nI3n1Aaw4XEu_2dW0","data":[],"key":"PsyiAj8Pm0"}],"key":"z16wiDhiDA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# alpha0 = Fp.rand()\nr1 = Fp(-32)\nr1","key":"nuGQFEH0Oe"},{"type":"output","id":"VITov-Np71AAqgdvQUy-t","data":[{"output_type":"execute_result","execution_count":22,"metadata":{},"data":{"text/plain":{"content":"-32","content_type":"text/plain"}}}],"key":"speJwGbkj7"}],"key":"jwGADkhVgn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck fold \n\nf2 = [(Fp(1) - r1) * f1_even[i] + r1 * f1_odd[i] for i in range(half)]\n\n# compute the new sum = h(r1)\nhz_r1 = UniPolynomial.evaluate_from_evals(hz, r1, [Fp(0), Fp(1)])\nhz_r1","key":"YGTp2AfJPB"},{"type":"output","id":"dx8K7eeE68sBbJBtE8o9E","data":[{"output_type":"execute_result","execution_count":23,"metadata":{},"data":{"text/plain":{"content":"-52","content_type":"text/plain"}}}],"key":"CHZqidnegx"}],"key":"W6eiWg3olV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"half >>= 1","key":"VeElX9xaEE"},{"type":"output","id":"bMYIegPr74ZCGyKPNahV2","data":[],"key":"Z6pLvI93az"}],"key":"GLPF2bdGM7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 2\n\nf2_even = f2[::2]\nf2_odd = f2[1::2]\nf2_even_mle = MLEPolynomial(f2_even, f_mle.num_var-3)\nf2_odd_mle = MLEPolynomial(f2_odd, f_mle.num_var-3)\n\n# construct hz(X): hz(X) = f2(X) = f(r0, r1, X)\nhz_at_0 = f2_even_mle.evaluate(us[3:])\nhz_at_1 = f2_odd_mle.evaluate(us[3:])\nhz = [hz_at_0, hz_at_1]\n\nassert (UniPolynomial.evaluate_from_evals(hz, us[2], [Fp(0), Fp(1)])) == hz_r1, \\\n    f\"hz(us[2]) = {UniPolynomial.evaluate_from_evals(hz, us[2])}, hz_r1 = {hz_r1}\"","key":"X1yxnzdzGf"},{"type":"output","id":"ja8TQuf3marZXF5NRMiIh","data":[],"key":"uPpm0mxAKY"}],"key":"qMQB3TV1Mn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# alpha0 = Fp.rand()\nr2 = Fp(-33)\nr2\n","key":"m42mYjYdG5"},{"type":"output","id":"lo-wHxsvw4DvRFlL8WKQW","data":[{"output_type":"execute_result","execution_count":26,"metadata":{},"data":{"text/plain":{"content":"-33","content_type":"text/plain"}}}],"key":"L00UD6rWJC"}],"key":"efROPmTbLt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck fold \n\nf3 = [(Fp(1) - r2) * f2_even[i] + r2 * f2_odd[i] for i in range(half)]\n\n# compute the new sum = h(r2)\nhz_r2 = UniPolynomial.evaluate_from_evals(hz, r2, [Fp(0), Fp(1)])\nhz_r2","key":"H7OhaPcnuv"},{"type":"output","id":"bU9aZJg90tcVEKNCeiZGE","data":[{"output_type":"execute_result","execution_count":27,"metadata":{},"data":{"text/plain":{"content":"-86","content_type":"text/plain"}}}],"key":"u9UDRgYH5b"}],"key":"AQFoLy7QKe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Check the final result: h(r0, r1, r2) = f(r0, r1, r2)\n\nhz_r2 == f_mle.evaluate([r0, r1,r2])","key":"rBH6fxlivo"},{"type":"output","id":"_HR7RHycUG8QpZTkwfmFc","data":[{"output_type":"execute_result","execution_count":28,"metadata":{},"data":{"text/plain":{"content":"True","content_type":"text/plain"}}}],"key":"Su0uwXFr6E"}],"key":"vz573dMJEo"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Simplified Sumcheck","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gQIzOrXFbH"}],"identifier":"simplified-sumcheck","label":"Simplified Sumcheck","html_id":"simplified-sumcheck","implicit":true,"key":"iSgXitqBry"}],"key":"HA7mox9vDd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"sum_checked = v\nhalf = n >> 1\nk = len(us)\n# f_code = f0_code\n# coset = self.coset_gen\nconstant = None\nr_vec = []\nsumcheck_h_vec = []\n# code_commitments = []\n# trees = [MerkleTree(f_code)]\n# codes = [f_code]","key":"op4NJcgaHt"},{"type":"output","id":"I5FWBU5P5zFezaxP7BQHO","data":[],"key":"XoLkyViTpu"}],"key":"YSa7UtHDcI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f_partial_evals = expanded_partial_evaluate(f, us)\nf_partial_evals","key":"Tdqf91O5qz"},{"type":"output","id":"MyiZ4kX4orCEyDkjqwyG2","data":[{"name":"stdout","output_type":"stream","text":"rs=[]\nrs=[3, -7, 0, 3]\nrs=[3, -7, 0, 3, 6, -17]\n"},{"output_type":"execute_result","execution_count":30,"metadata":{},"data":{"text/plain":{"content":"[3, -7, 0, 3, 6, -17, -40]","content_type":"text/plain"}}}],"key":"z03iweEBzH"}],"key":"TQUIhvAjfX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 0\ni = 0 \n\nf_even = f[::2]\nf_odd = f[1::2]\nprint(f\"P> f = {f}\")\n\n# construct h_i(X) = f_i(r0,r1,...,X,u_{i+1},u_{i+2},...,u_k)\nh_at_0 = f_partial_evals[-3]\nh_at_1 = f_partial_evals[-2]\nh_at_u = f_partial_evals[-1]\nh_at_u_plus_1 = h_at_u + (h_at_1 - h_at_0)\n\nprint(f\"P> h_at_0 = {h_at_0}\")\nprint(f\"P> h_at_1 = {h_at_1}\")\nprint(f\"P> h_at_u = {h_at_u}\")\nprint(f\"P> h_plus_1_at_u = {h_at_u_plus_1}\")\n\nif debug > 0:\n    print(f\"P> check h(0), h(1), h(u), h(u+1)\")\n    partial_f_mle = MLEPolynomial(f, k-i)\n    assert h_at_0 == partial_f_mle.evaluate([Fp(0)]+us[i+1:]), \\\n        f\"h_at_0 = {h_at_0}, partial_f_mle.evaluate([Fp(0)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\"\n    assert h_at_1 == partial_f_mle.evaluate([Fp(1)]+us[i+1:]), \\\n        f\"h_at_1 = {h_at_1}, partial_f_mle.evaluate([Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(1)]+us[i+1:])}\"\n    assert h_at_u == partial_f_mle.evaluate(us[i:]), \\\n        f\"h_at_u = {h_at_u}, partial_f_mle.evaluate(us[i:]) = {partial_f_mle.evaluate(us[i:])}\"\n    assert h_at_u_plus_1 == partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]), \\\n        f\"h_plus_1_at_u = {h_at_u_plus_1}, partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\"\n    # print(f\"P> f(0) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\")\n    # print(f\"P> f(u) = {partial_f_mle.evaluate(us[i:])}\")\n    # print(f\"P> f(u+1) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\")\n    assert h_at_u == sum_checked, \\\n        f\"h_at_u = {h_at_u}, sum_checked = {sum_checked}\"\n    print(f\"P> check h_at_u passed, {h_at_u} = {sum_checked}\")\nsumcheck_h_vec.append(h_at_u)\n\n# tr.absorb(b\"h(X)\", h_eval_at_u_plus_1)\n\n# check sum\n# assert UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)]) == sum_checked, \\\n#     f\"h(us[{i}]) = {UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)])}, sum_checked = {sum_checked}\"\n\n# Receive a random number from the verifier\nr = Fp(-12)\n\nif debug > 0:\n    print(f\"P> r[{i}] = {r}\")\n\n\n# NOTE: The verifier compute f_i(r), which is *equal to* f_{i+1}(u_i). And then in \n#   the next round, the prover will only need to send f_{i+1}(u_i+1) to the verifier.\n#   The computation of f_{i+1}(r) at the verifier's side costs only one multiplication.\nh_at_r = h_at_u + (h_at_u_plus_1 - h_at_u) * (r - us[i])\n\nif debug > 0:\n    print(f\"P> check new sumcheck passed\")\n    assert h_at_r == MLEPolynomial(f, k-i).evaluate([r]+us[i+1:]), \\\n        f\"h_at_r = {h_at_r}, f(r) = {MLEPolynomial(f, k-i).evaluate([r]+us[i+1:])}\"\n    new_sum = UniPolynomial.evaluate_from_evals([h_at_u, h_at_u_plus_1], r, [us[i], us[i]+Fp(1)])\n    assert h_at_r == new_sum\n    print(f\"P> check new sumcheck passed, {h_at_r} = {new_sum}\")\n\n# fold f\n\n# f_folded = [(Fp(1) - r) * f_even[i] + r * f_odd[i] for i in range(half)]\nf_folded = fold(f, r)\n\nf_parital_evals_trimmed = f_partial_evals[:-1]\nf_parital_even = f_parital_evals_trimmed[::2]\nf_parital_odd = f_parital_evals_trimmed[1::2]\nprint(f\"P> f_parital_evals_trimmed = {f_parital_evals_trimmed}\")\nf_parital_evals_folded = fold(f_parital_evals_trimmed, r)\n","key":"v6es27ADof"},{"type":"output","id":"gE_x_thIuHU962g_BzOxX","data":[{"name":"stdout","output_type":"stream","text":"P> f = [1, 3, 2, 1, 2, -2, 1, 2]\nP> h_eval_at_0 = 6\nP> h_eval_at_1 = -17\nP> h_eval_at_u = -40\nP> h_eval_at_u_plus_1 = -63\nP> check h(0), h(1), h(u), h(u+1)\nP> check h_eval_at_u passed, -40 = -40\nP> r[0] = -12\nP> check new sumcheck passed\nP> check new sumcheck passed, 89 = 89\nP> f_parital_evals_trimmed = [3, -7, 0, 3, 6, -17]\n"}],"key":"WzLviuDijj"}],"key":"mM5EbQnYni"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# # update parameters for the next round\nsum_checked = h_at_r\nr_vec.append(r)\nf = f_folded\nf_partial_evals = f_parital_evals_folded\n# f_code = f_code_folded\nhalf >>= 1\ncoset *= coset","key":"f1oa336CST"},{"type":"output","id":"Ce0KHcfCQImgeWI0QohTB","data":[],"key":"JJl9RUYUiv"}],"key":"D3K1KozCyQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"f_partial_evals, half","key":"MD6yiqdqpw"},{"type":"output","id":"DjDc7zJQlfvAJ_dm5GWXN","data":[{"output_type":"execute_result","execution_count":35,"metadata":{},"data":{"text/plain":{"content":"([-70, -36, 89], 2)","content_type":"text/plain"}}}],"key":"EkrlVXFNg8"}],"key":"gWt4j56Nka"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 1\ni = 1\n\nf_even = f[::2]\nf_odd = f[1::2]\nprint(f\"P> f = {f}\")\n\n# construct h(X)\nh_eval_at_0 = f_partial_evals[-3]\nh_eval_at_1 = f_partial_evals[-2]\nh_eval_at_u = f_partial_evals[-1]\nh_eval_at_u_plus_1 = h_eval_at_u + (h_eval_at_1 - h_eval_at_0)\n\nprint(f\"P> h_eval_at_0 = {h_eval_at_0}\")\nprint(f\"P> h_eval_at_1 = {h_eval_at_1}\")\nprint(f\"P> h_eval_at_u = {h_eval_at_u}\")\nprint(f\"P> h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}\")\n\nif debug > 0:\n    print(f\"P> check h(0), h(1), h(u), h(u+1)\")\n    partial_f_mle = MLEPolynomial(f, k-i)\n    assert h_eval_at_0 == partial_f_mle.evaluate([Fp(0)]+us[i+1:]), \\\n        f\"h_eval_at_0 = {h_eval_at_0}, partial_f_mle.evaluate([Fp(0)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\"\n    assert h_eval_at_1 == partial_f_mle.evaluate([Fp(1)]+us[i+1:]), \\\n        f\"h_eval_at_1 = {h_eval_at_1}, partial_f_mle.evaluate([Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(1)]+us[i+1:])}\"\n    assert h_eval_at_u == partial_f_mle.evaluate(us[i:]), \\\n        f\"h_eval_at_u = {h_eval_at_u}, partial_f_mle.evaluate(us[i:]) = {partial_f_mle.evaluate(us[i:])}\"\n    assert h_eval_at_u_plus_1 == partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]), \\\n        f\"h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}, partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\"\n    # print(f\"P> f(0) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\")\n    # print(f\"P> f(u) = {partial_f_mle.evaluate(us[i:])}\")\n    # print(f\"P> f(u+1) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\")\n    assert h_eval_at_u == sum_checked, \\\n        f\"h_eval_at_u = {h_eval_at_u}, sum_checked = {sum_checked}\"\n    print(f\"P> check h_eval_at_u passed, {h_eval_at_u} = {sum_checked}\")\nsumcheck_h_vec.append(h_eval_at_u_plus_1)\n\n# tr.absorb(b\"h(X)\", h_eval_at_u_plus_1)\n\n# check sum\n# assert UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)]) == sum_checked, \\\n#     f\"h(us[{i}]) = {UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)])}, sum_checked = {sum_checked}\"\n\n# Receive a random number from the verifier\nr = Fp(-13)\n\nif debug > 0:\n    print(f\"P> r[{i}] = {r}\")\n\nh_eval_at_r = h_eval_at_u + (h_eval_at_u_plus_1 - h_eval_at_u) * (r - us[i])\n\nif debug > 0:\n    print(f\"P> check new sumcheck passed\")\n    assert h_eval_at_r == MLEPolynomial(f, k-i).evaluate([r]+us[i+1:]), \\\n        f\"h_eval_at_r = {h_eval_at_r}, f(r) = {MLEPolynomial(f, k-i).evaluate([r]+us[i+1:])}\"\n    new_sum = UniPolynomial.evaluate_from_evals([h_eval_at_u, h_eval_at_u_plus_1], r, [us[i], us[i]+Fp(1)])\n    assert h_eval_at_r == new_sum\n    print(f\"P> check new sumcheck passed, {h_eval_at_r} = {new_sum}\")\n\n# fold f\n\n# f_folded = [(Fp(1) - r) * f_even[i] + r * f_odd[i] for i in range(half)]\nf_folded = fold(f, r)\n\nf_parital_evals_trimmed = f_partial_evals[:-1]\nf_parital_even = f_parital_evals_trimmed[::2]\nf_parital_odd = f_parital_evals_trimmed[1::2]\nprint(f\"P> f_parital_evals_trimmed = {f_parital_evals_trimmed}\")\nf_parital_evals_folded = fold(f_parital_evals_trimmed, r)\nprint(f\"P> f_parital_evals_folded = {f_parital_evals_folded}\")\n","key":"NmhplulGZ6"},{"type":"output","id":"VMcJKLleh91bpnY9m8daW","data":[{"name":"stdout","output_type":"stream","text":"P> f = [-23, 14, 50, -11]\nP> h_eval_at_0 = -70\nP> h_eval_at_1 = -36\nP> h_eval_at_u = 89\nP> h_eval_at_u_plus_1 = -70\nP> check h(0), h(1), h(u), h(u+1)\nP> check h_eval_at_u passed, 89 = 89\nP> r[1] = -13\nP> check new sumcheck passed\nP> check new sumcheck passed, 67 = 67\nP> f_parital_evals_trimmed = [-70, -36]\nP> f_parital_evals_folded = [67]\n"}],"key":"PvxmvYBkOh"}],"key":"sMKyINiW10"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# # update parameters for the next round\nsum_checked = h_eval_at_r\nr_vec.append(r)\nf = f_folded\nf_partial_evals = f_parital_evals_folded\n# f_code = f_code_folded\nhalf >>= 1\ncoset *= coset","key":"UU5LcyR2sE"},{"type":"output","id":"6C5jWqVBsynAUGnfCo5BI","data":[],"key":"vkXtTwJLH9"}],"key":"uYgMbLgSDN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# Sumcheck Round 2 (final round)\ni = 2\n\nf_even = f[::2]\nf_odd = f[1::2]\nprint(f\"P> f = {f}\")\n\n# construct h(X)\nh_eval_at_0 = f_partial_evals[0]\nh_eval_at_1 = f_partial_evals[0]\nh_eval_at_u = f_partial_evals[0]\nh_eval_at_u_plus_1 = h_eval_at_u + (h_eval_at_1 - h_eval_at_0)\n\nprint(f\"P> h_eval_at_0 = {h_eval_at_0}\")\nprint(f\"P> h_eval_at_1 = {h_eval_at_1}\")\nprint(f\"P> h_eval_at_u = {h_eval_at_u}\")\nprint(f\"P> h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}\")\n\nif debug > 0:\n    print(f\"P> check h(0), h(1), h(u), h(u+1)\")\n    partial_f_mle = MLEPolynomial(f, k-i)\n    assert h_eval_at_0 == partial_f_mle.evaluate([Fp(0)]+us[i+1:]), \\\n        f\"h_eval_at_0 = {h_eval_at_0}, partial_f_mle.evaluate([Fp(0)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\"\n    assert h_eval_at_1 == partial_f_mle.evaluate([Fp(1)]+us[i+1:]), \\\n        f\"h_eval_at_1 = {h_eval_at_1}, partial_f_mle.evaluate([Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(1)]+us[i+1:])}\"\n    assert h_eval_at_u == partial_f_mle.evaluate(us[i:]), \\\n        f\"h_eval_at_u = {h_eval_at_u}, partial_f_mle.evaluate(us[i:]) = {partial_f_mle.evaluate(us[i:])}\"\n    assert h_eval_at_u_plus_1 == partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]), \\\n        f\"h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}, partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\"\n    # print(f\"P> f(0) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\")\n    # print(f\"P> f(u) = {partial_f_mle.evaluate(us[i:])}\")\n    # print(f\"P> f(u+1) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\")\n    assert h_eval_at_u == sum_checked, \\\n        f\"h_eval_at_u = {h_eval_at_u}, sum_checked = {sum_checked}\"\n    print(f\"P> check h_eval_at_u passed, {h_eval_at_u} = {sum_checked}\")\nsumcheck_h_vec.append(h_eval_at_u_plus_1)\n\n# tr.absorb(b\"h(X)\", h_eval_at_u_plus_1)\n\n# check sum\n# assert UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)]) == sum_checked, \\\n#     f\"h(us[{i}]) = {UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)])}, sum_checked = {sum_checked}\"\n\n# Receive a random number from the verifier\nr = Fp(-13)\n\nif debug > 0:\n    print(f\"P> r[{i}] = {r}\")\n\n# NOTE: The verifier compute f_i(r), which is *equal to* f_{i+1}(u_i). And then in \n#   the next round, the prover will only need to send f_{i+1}(u_i+1) to the verifier.\nh_eval_at_r = h_eval_at_u + (h_eval_at_u_plus_1 - h_eval_at_u) * (r - us[i])\n\nif debug > 0:\n    print(f\"P> check new sumcheck passed\")\n    assert h_eval_at_r == MLEPolynomial(f, k-i).evaluate([r]+us[i+1:]), \\\n        f\"h_eval_at_r = {h_eval_at_r}, f(r) = {MLEPolynomial(f, k-i).evaluate([r]+us[i+1:])}\"\n    new_sum = UniPolynomial.evaluate_from_evals([h_eval_at_u, h_eval_at_u_plus_1], r, [us[i], us[i]+Fp(1)])\n    assert h_eval_at_r == new_sum\n    print(f\"P> check new sumcheck passed, {h_eval_at_r} = {new_sum}\")\n\n# fold f\n\n# f_folded = [(Fp(1) - r) * f_even[i] + r * f_odd[i] for i in range(half)]\nf_folded = fold(f, r)\n\nf_parital_evals_trimmed = f_partial_evals[:-1]\nf_parital_even = f_parital_evals_trimmed[::2]\nf_parital_odd = f_parital_evals_trimmed[1::2]\nprint(f\"P> f_parital_evals_trimmed = {f_parital_evals_trimmed}\")\nf_parital_evals_folded = fold(f_parital_evals_trimmed, r)\nprint(f\"P> f_parital_evals_folded = {f_parital_evals_folded}\")\n","key":"qpzQpsmJyj"},{"type":"output","id":"ZI3rNVksj6Iy8JKPGXNgB","data":[],"key":"jKf6pN006j"}],"key":"CXamlmIPIx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"# # Sumcheck Round 1\n# i = 0 \n\n# f_even = f[::2]\n# f_odd = f[1::2]\n# print(f\"P> f = {f}\")\n\n# # construct h(X)\n# h_eval_at_0 = MLEPolynomial(f_even, k-i-1).evaluate(us[i+1:])\n# h_eval_at_1 = MLEPolynomial(f_odd, k-i-1).evaluate(us[i+1:])\n# h_eval_at_u = (Fp(1) - us[i]) * h_eval_at_0 + us[i] * h_eval_at_1\n# h_eval_at_u_plus_1 = h_eval_at_u + (h_eval_at_1 - h_eval_at_0)\n\n# print(f\"P> h_eval_at_0 = {h_eval_at_0}\")\n# print(f\"P> h_eval_at_1 = {h_eval_at_1}\")\n# print(f\"P> h_eval_at_u = {h_eval_at_u}\")\n# print(f\"P> h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}\")\n\n# if debug > 0:\n#     print(f\"P> check h(0), h(1), h(u), h(u+1)\")\n#     partial_f_mle = MLEPolynomial(f, k-i)\n#     assert h_eval_at_0 == partial_f_mle.evaluate([Fp(0)]+us[i+1:]), \\\n#         f\"h_eval_at_0 = {h_eval_at_0}, partial_f_mle.evaluate([Fp(0)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\"\n#     assert h_eval_at_1 == partial_f_mle.evaluate([Fp(1)]+us[i+1:]), \\\n#         f\"h_eval_at_1 = {h_eval_at_1}, partial_f_mle.evaluate([Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([Fp(1)]+us[i+1:])}\"\n#     assert h_eval_at_u == partial_f_mle.evaluate(us[i:]), \\\n#         f\"h_eval_at_u = {h_eval_at_u}, partial_f_mle.evaluate(us[i:]) = {partial_f_mle.evaluate(us[i:])}\"\n#     assert h_eval_at_u_plus_1 == partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]), \\\n#         f\"h_eval_at_u_plus_1 = {h_eval_at_u_plus_1}, partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:]) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\"\n#     # print(f\"P> f(0) = {partial_f_mle.evaluate([Fp(0)]+us[i+1:])}\")\n#     # print(f\"P> f(u) = {partial_f_mle.evaluate(us[i:])}\")\n#     # print(f\"P> f(u+1) = {partial_f_mle.evaluate([us[i]+Fp(1)]+us[i+1:])}\")\n#     assert h_eval_at_u == sum_checked, \\\n#         f\"h_eval_at_u = {h_eval_at_u}, sum_checked = {sum_checked}\"\n#     print(f\"P> check h_eval_at_u passed, {h_eval_at_u} = {sum_checked}\")\n# sumcheck_h_vec.append(h_eval_at_u_plus_1)\n\n# # tr.absorb(b\"h(X)\", h_eval_at_u_plus_1)\n\n# # check sum\n# # assert UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)]) == sum_checked, \\\n# #     f\"h(us[{i}]) = {UniPolynomial.evaluate_from_evals(h, us[i], [Field(0), Field(1)])}, sum_checked = {sum_checked}\"\n\n# # Receive a random number from the verifier\n# r = Fp(-12)\n\n# if debug > 0:\n#     print(f\"P> r[{i}] = {r}\")\n\n# h_eval_at_r = h_eval_at_u + (h_eval_at_u_plus_1 - h_eval_at_u) * (r - us[i])\n\n# if debug > 0:\n#     print(f\"P> check new sumcheck passed\")\n#     assert h_eval_at_r == MLEPolynomial(f, k-i).evaluate([r]+us[i+1:]), \\\n#         f\"h_eval_at_r = {h_eval_at_r}, f(r) = {MLEPolynomial(f, k-i).evaluate([r]+us[i+1:])}\"\n#     new_sum = UniPolynomial.evaluate_from_evals([h_eval_at_u, h_eval_at_u_plus_1], r, [us[i], us[i]+Fp(1)])\n#     assert h_eval_at_r == new_sum\n#     print(f\"P> check new sumcheck passed, {h_eval_at_r} = {new_sum}\")\n\n# # fold f\n\n# f_folded = [(Fp(1) - r) * f_even[i] + r * f_odd[i] for i in range(half)]\n","key":"LmbMJ2IAzw"},{"type":"output","id":"WM-4DOsM7b2TiNqkQxFdr","data":[],"key":"eBOZsBcfvs"}],"key":"N0PVtuCsEN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"sage","executable":true,"value":"","key":"KKp4r1Sn47"},{"type":"output","id":"6e69rHatyxMioa3Gp2HmR","data":[],"key":"dp7jIKZGJB"}],"key":"sTPsUu4ROy"}],"key":"wD5qcCzze2"},"references":{"cite":{"order":[],"data":{}}}}